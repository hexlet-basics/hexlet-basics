upstream code_basics_backend {
  server localhost:3000;
}

upstream code_basics_cable_backend {
  server localhost:28080;
}

# first server block in config is used by default for requests with unknown server_name
# It is used by kubernetes for health checking nginx container
server {
  listen 8080 default_server;
  listen [::]:8080 default_server;

  server_tokens off;

  return 200;
}

# üéØ Redirects (www, ru subdomains)
server {
  listen 8080;
  listen [::]:8080;

  server_tokens off;

  server_name ~^www\.(.*)$ ru.code-basics.com code-basics.ru;
  return 301 https://code-basics.com/ru$request_uri;
}

# Maintenance server block (uncomment if maintenance mode)
# server {
#   listen 8080;
#   listen [::]:8080;

#   server_name code-basics.com;

#   location /system/ {
#     root /;
#   }

#   location / {
#     return 503;
#   }

#   error_page 503 /system/maintenance.html;

#   location = /system/maintenance.html {
#     root /;
#     add_header Retry-After 3600;
#   }
# }

# üåê Main server block
server {
  listen 8080;
  listen [::]:8080;

  server_tokens off;

  server_name code-basics.com;
  root /var/www/code-basics/shared/public;
  charset UTF-8;

  access_log off;

  client_max_body_size 10M;
  keepalive_timeout 620s;

  # Security headers
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options SAMEORIGIN;
  add_header X-XSS-Protection "1; mode=block";
  add_header Referrer-Policy no-referrer-when-downgrade;
  add_header Cross-Origin-Opener-Policy same-origin always;
  add_header Cross-Origin-Embedder-Policy require-corp always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()";

  # üå¨Ô∏è Enable Gzip globally
  # gzip_static on;
  gzip_proxied any;
  gzip_disable "msie6";
  gzip_types
    text/plain text/css application/json application/javascript
    text/xml application/xml application/xml+rss text/javascript
    application/vnd.ms-fontobject application/x-font-ttf font/opentype
    image/svg+xml image/x-icon;

  # üì¶ Static assets
  location ~ ^/vite/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header Last-Modified "";
    add_header ETag "";

    sendfile on;
    tcp_nopush on;
    sendfile_max_chunk 1m;

    # –ï—Å–ª–∏ Vite –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç gz —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–¥–∞–≤–∞—Ç—å —Å—Ä–∞–∑—É
    # gzip_static on;

    try_files $uri =404;
    error_page 404 = @empty_404;
  }

  # Serve ActiveStorage representations with cache
  location ~ ^/rails/active_storage/representations/(redirect|proxy)/ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000";
    include snippets/cors.conf;
    proxy_pass http://code_basics_backend;

    proxy_intercept_errors on;
    error_page 404 = @empty_404;
  }

  location @empty_404 {
    return 404 "Not Found";
    add_header Content-Type text/plain;
  }

  location ^~ /cable {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_pass http://code_basics_cable_backend;
  }

  location / {
    try_files $uri @app;
  }

  # üîÅ Proxy to Rails
  location @app {
    rewrite ^/(.*)/$ /$1 permanent;

    gzip on;

    # CORS preflight
    if ($request_method = 'OPTIONS') {
      include snippets/cors.conf;
      add_header Content-Type 'text/plain; charset=utf-8';
      add_header Content-Length 0;
      return 204;
    }

    if ($request_method = 'GET') {
      include snippets/cors.conf;
      add_header Permissions-Policy 'browsing-topics=()';
    }

    # –í—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º, –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –Ω–∞–¥–æ –ª–∏ —â–∞—Å
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è —è–Ω–¥–µ–∫—Å –≤–µ–±–º–∞—Å—Ç–µ—Ä–∞ / –∫–∞—Ä—Ç—ã –∫–ª–∏–∫–æ–≤
    # proxy_hide_header X-Frame-Options;
    # set $frame_options 'SAMEORIGIN';
    # if ($http_referer ~ '^https?:\/\/([^\/]+\.)?(code-basics\.com|webvisor\.com|metri[ck]a\.yandex\.(com|ru|by|com\.tr))\/'){
    #   set $frame_options '';
    # }
    # add_header X-Frame-Options $frame_options always;

    include snippets/proxy_headers.conf;

    proxy_pass http://code_basics_backend;
  }
}
